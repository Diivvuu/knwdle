generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

/* =========================================================
   CORE AUTH
========================================================= */

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String?
  profilePhoto  String?
  mobile        String?  @db.VarChar(20)
  gender        String?
  dateOfBirth   DateTime?
  address       String?
  bio           String?
  emailVerified DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions       Session[]
  verificationTokens VerificationToken[]
  otpTokens          OtpToken[]
  notifications      Notification[]

  memberships    OrgMembership[]
  studentProfile StudentProfile?

  guardianLinks GuardianLink[] @relation("ParentLinks")
  parentLinks   GuardianLink[] @relation("StudentLinks")

  attendance AttendanceRecord[] @relation("UserAttendance")
  submissions Submission[]      @relation("UserSubmissions")
  feeInvoices FeeInvoice[]      @relation("UserInvoices")

  taughtSessions TimeTableEntry[] @relation("TeacherSessions")

  results      ResultRecord[]
  achievements Achievement[]
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OtpToken {
  id        String   @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, code])
}

model Notification {
  id        String   @id @default(cuid())
  orgId     String?
  userId    String
  type      String
  title     String
  body      String
  meta      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

/* =========================================================
   ORGANISATION
========================================================= */

enum OrgType {
  SCHOOL
  COACHING_CENTER
  TUITION_CENTER
  COLLEGE
  UNIVERSITY
  EDTECH
  TRAINING
  NGO
}

model Organisation {
  id           String   @id @default(cuid())
  name         String
  type         OrgType
  description  String?
  teamSize     String?
  country      String?
  timezone     String?
  logoUrl      String?
  coverUrl     String?
  brand_color  String?
  address      String?
  contactPhone String?
  createdAt    DateTime @default(now())

  audiences     Audience[]
  members      OrgMembership[]
  invites      Invite[]
  roles        Role[]
  settings     OrgSettings[]
  taxProfiles  TaxProfile[]
  profile      OrgProfile?
  announcement Announcement[]
}

model OrgProfile {
  id    String @id @default(cuid())
  orgId String @unique
  meta  Json

  org Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

/* =========================================================
   AUDIENCES (OrgAudience = set of users, nothing more)
========================================================= */

model Audience {
  id        String   @id @default(cuid())
  orgId     String
  name      String 
  parentId  String?
  meta      Json     @default("{}")
  isExclusive   Boolean     @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org      Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  parent   Audience?    @relation("AudienceParent", fields: [parentId], references: [id])
  children Audience[]   @relation("AudienceParent")

  members OrgMembership[]
  invites Invite[]
  timetableEntries   TimeTableEntry[]
  attendanceSessions AttendanceSession[]
  contentItems       ContentItem[]
  feeInvoices        FeeInvoice[]
  announcements      Announcement[]

  @@index([orgId])
  @@index([orgId, parentId])
}
/* =========================================================
   MEMBERSHIPS & ROLES
========================================================= */

enum ParentRole {
  admin
  staff
  student
  parent
}

model OrgMembership {
  id           String     @id @default(cuid())
  orgId        String
  userId       String
  role         ParentRole
  audienceId   String?
  createdAt    DateTime   @default(now())

  roleId       String?
  customerRole Role? @relation("MembershipCustomRole", fields: [roleId], references: [id])

  org          Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  audience     Audience?     @relation(fields: [audienceId], references: [id], onDelete: SetNull)

  @@unique([orgId, userId, audienceId])
  @@index([orgId, userId])
  @@index([orgId, role])
  @@index([orgId, audienceId])
}

model Role {
  id         String     @id @default(cuid())
  orgId      String
  key        String
  name       String
  scope      String
  parentRole ParentRole
  createdAt  DateTime @default(now())

  org         Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  memberships OrgMembership[] @relation("MembershipCustomRole")
  invites     Invite[]

  @@unique([orgId, key])
}

model Permission {
  id    String @id @default(cuid())
  code  String @unique
  name  String

  roles RolePermission[]
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

/* =========================================================
   INVITES
========================================================= */

model Invite {
  id         String   @id @default(cuid())
  email      String
  orgId      String
  role       ParentRole
  audienceId     String?
  token      String   @unique
  joinCode   String?  @unique
  expiresAt  DateTime
  acceptedBy String?
  createdAt  DateTime @default(now())
  meta       Json?

  roleId  String?
  roleRef Role? @relation(fields: [roleId], references: [id], onDelete: SetNull)
  org     Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  audience    Audience? @relation(fields: [audienceId], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt])
  @@index([orgId, expiresAt])
}

model InviteBatch {
  id        String   @id @default(cuid())
  orgId     String
  total     Int
  sent      Int      @default(0)
  failed    Int      @default(0)
  skipped   Int      @default(0)
  status    String   @default("queued")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, createdAt])
}

/* =========================================================
   STUDENT / PARENT
========================================================= */

model StudentProfile {
  id     String @id @default(cuid())
  userId String @unique
  rollNo String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GuardianLink {
  id        String @id @default(cuid())
  parentId  String
  studentId String
  relation  String?

  parent  User @relation("ParentLinks", fields: [parentId], references: [id], onDelete: Cascade)
  student User @relation("StudentLinks", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
}

/* =========================================================
   TIMETABLE & ATTENDANCE
========================================================= */
model Announcement {
  id        String   @id @default(cuid())
  orgId     String
  audienceId    String?
  title     String
  body      String?
  createdBy String
  pin       Boolean  @default(false)
  createdAt DateTime @default(now())

  org      Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  audience Audience?    @relation(fields: [audienceId], references: [id], onDelete: SetNull)

  @@index([orgId, audienceId, createdAt])
}

model TimeTableEntry {
  id        String   @id @default(cuid())
  orgId     String
  audienceId    String
  dayOfWeek Int
  startTime String
  endTime   String
  teacherId String?
  room      String?
  mode      String?
  priority  Int      @default(0)
  meta      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  audience  Audience @relation(fields: [audienceId], references: [id], onDelete: Cascade)
  teacher   User?   @relation("TeacherSessions", fields: [teacherId], references: [id])

  attendanceSessions AttendanceSession[]

  @@index([orgId, audienceId, dayOfWeek])
}

model AttendanceSession {
  id               String   @id @default(cuid())
  orgId            String
  audienceId           String
  date             DateTime
  period           String?
  takenById        String?
  notes            String?
  timeTableEntryId String?
  createdAt        DateTime @default(now())

  audience          Audience            @relation(fields: [audienceId], references: [id], onDelete: Cascade)
  timetable         TimeTableEntry?     @relation(fields: [timeTableEntryId], references: [id])
  records           AttendanceRecord[]

  @@unique([orgId, audienceId, date, period])
  @@index([orgId, audienceId, date])
}

model AttendanceRecord {
  id        String   @id @default(cuid())
  sessionId String
  studentId String
  status    String
  meta      Json?
  createdAt DateTime @default(now())

  session AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User              @relation("UserAttendance", fields: [studentId], references: [id])

  @@unique([sessionId, studentId])
}

/* =========================================================
   CONTENT / RESULTS / FINANCE
========================================================= */

model ContentItem {
  id        String   @id @default(cuid())
  orgId     String
  audienceId    String
  type      String
  title     String
  body      String?
  dueAt     DateTime?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  audience        Audience      @relation(fields: [audienceId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@index([orgId, audienceId, type, dueAt])
}

model Submission {
  id          String   @id @default(cuid())
  contentId   String
  studentId   String
  submittedAt DateTime?
  grade       Float?
  feedback    String?
  meta        Json?
  createdAt   DateTime @default(now())

  content ContentItem @relation(fields: [contentId], references: [id], onDelete: Cascade)
  student User        @relation("UserSubmissions", fields: [studentId], references: [id])

  @@unique([contentId, studentId])
}

model ResultRecord {
  id        String   @id @default(cuid())
  orgId     String
  studentId String
  title     String
  score     Float
  total     Float
  grade     String?
  remarks   String?
  date      DateTime
  createdAt DateTime @default(now())

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([orgId, studentId, date])
}

model Achievement {
  id          String   @id @default(cuid())
  orgId       String
  studentId   String
  title       String
  description String
  icon        String?
  awardedAt   DateTime @default(now())

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

/* =========================================================
   FINANCE & PLATFORM
========================================================= */

model TaxProfile {
  id        String   @id @default(cuid())
  orgId     String
  country   String  
  gstNo     String?
  vatNo     String?
  meta      Json?
  createdAt DateTime @default(now())

  org Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, country])
}

model FeeInvoice {
  id        String   @id @default(cuid())
  orgId     String
  audienceId    String?
  studentId String
  number    String   @unique
  title     String
  amount    Int
  currency  String   @default("INR")
  dueAt     DateTime
  status    String   @default("unpaid")
  meta      Json?
  createdAt DateTime @default(now())

  student User     @relation("UserInvoices", fields: [studentId], references: [id])
  audience    Audience? @relation(fields: [audienceId], references: [id], onDelete: SetNull)

  payments FeePayment[]

  @@index([orgId, studentId, status, dueAt])
}

model FeePayment {
  id        String   @id @default(cuid())
  invoiceId String
  amount    Int
  method    String
  reference String?
  paidAt    DateTime @default(now())
  meta      Json?

  invoice FeeInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model FileAsset {
  id        String   @id @default(cuid())
  orgId     String
  audienceId    String?
  ownerId   String?
  name      String
  mime      String
  size      Int
  url       String
  meta      Json?
  createdAt DateTime @default(now())

  @@index([orgId, audienceId, ownerId])
}

model OrgSettings {
  id    String @id @default(cuid())
  orgId String
  key   String
  value Json

  org Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, key])
}

model AuditLog {
  id        String   @id @default(cuid())
  orgId     String
  actorId   String?
  action    String
  entity    String?
  entityId  String?
  meta      Json?
  ip        String?
  createdAt DateTime @default(now())

  @@index([orgId, action, createdAt])
  @@index([entity, entityId])
}